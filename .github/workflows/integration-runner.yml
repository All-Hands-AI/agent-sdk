name: Run Integration Tests

on:
  pull_request:
    types: 
      - labeled
      - synchronize
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: true
        default: ''
  schedule:
    - cron: '30 22 * * *'  # Runs at 10:30pm UTC every day

env:
  N_PROCESSES: 4 # Global configuration for number of parallel processes for evaluation

jobs:
  run-integration-tests:
    if: github.event.label.name == 'integration-test' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: blacksmith-4vcpu-ubuntu-2204
    permissions:
      contents: "read"
      id-token: "write"
      pull-requests: "write"
      issues: "write"
    strategy:
      matrix:
        python-version: ["3.12"]
        llm-config:
          - model: "litellm_proxy/anthropic/claude-sonnet-4-20250514"
            name: "Claude Sonnet 4"
            run-suffix: "sonnet_run"
          - model: "litellm_proxy/openai/gpt-5-mini"
            name: "GPT-5 Mini"
            run-suffix: "gpt5_mini_run"
          - model: "litellm_proxy/deepseek/deepseek-chat"
            name: "DeepSeek Chat"
            run-suffix: "deepseek_run"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}

      - name: Comment on PR if 'integration-test' label is present
        if: github.event_name == 'pull_request' && github.event.label.name == 'integration-test'
        uses: KeisukeYamashita/create-comment@v1
        with:
          unique: false
          comment: |
            Hi! I started running the integration tests on your PR. You will receive a comment with the results shortly.

      - name: Install Python dependencies using uv
        run: |
          uv sync --dev
          uv pip install pytest

      # Run integration test evaluation
      - name: Run integration test evaluation for ${{ matrix.llm-config.name }}
        env:
          LLM_MODEL: ${{ matrix.llm-config.model }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        run: |
          ./tests/integration/run_infer.sh "$LLM_MODEL" "$LLM_API_KEY" "$LLM_BASE_URL" $N_PROCESSES '' '${{ matrix.llm-config.run-suffix }}'

          # get integration tests report
          REPORT_FILE=$(find tests/integration/outputs/*${{ matrix.llm-config.run-suffix }}* -name "report.md" -type f | head -n 1)
          echo "REPORT_FILE: $REPORT_FILE"
          if [ -f "$REPORT_FILE" ]; then
            echo "INTEGRATION_TEST_REPORT<<EOF" >> $GITHUB_ENV
            cat $REPORT_FILE >> $GITHUB_ENV
            echo >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "INTEGRATION_TEST_REPORT=No report file found" >> $GITHUB_ENV
          fi

      - name: Wait a little bit
        run: sleep 10





      - name: Create archive of evaluation outputs
        run: |
          TIMESTAMP=$(date +'%y-%m-%d-%H-%M')
          cd tests/integration/outputs  # Change to the outputs directory
          tar -czvf ../../../integration_tests_${{ matrix.llm-config.run-suffix }}_${TIMESTAMP}.tar.gz *${{ matrix.llm-config.run-suffix }}* # Include result directories for this model

      - name: Upload evaluation results as artifact
        uses: actions/upload-artifact@v4
        id: upload_results_artifact
        with:
          name: integration-test-outputs-${{ matrix.llm-config.run-suffix }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: integration_tests_${{ matrix.llm-config.run-suffix }}_*.tar.gz

      - name: Get artifact URLs
        run: |
          echo "ARTIFACT_URL=${{ steps.upload_results_artifact.outputs.artifact-url }}" >> $GITHUB_ENV

      - name: Set timestamp and trigger reason
        run: |
          echo "TIMESTAMP=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_ENV
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "TRIGGER_REASON=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TRIGGER_REASON=manual-${{ github.event.inputs.reason }}" >> $GITHUB_ENV
          else
            echo "TRIGGER_REASON=nightly-scheduled" >> $GITHUB_ENV
          fi

      - name: Comment with results and artifact link
        id: create_comment
        uses: KeisukeYamashita/create-comment@v1
        with:
          # if triggered by PR, use PR number, otherwise use 9745 as fallback issue number for manual triggers
          number: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || 9745 }}
          unique: false
          comment: |
              Trigger by: ${{ github.event_name == 'pull_request' && format('Pull Request (integration-test label on PR #{0})', github.event.pull_request.number) || (github.event_name == 'workflow_dispatch' && format('Manual Trigger: {0}', github.event.inputs.reason)) || 'Nightly Scheduled Run' }}
              Commit: ${{ github.sha }}
              **Integration Tests Report (${{ matrix.llm-config.name }})**
              ${{ matrix.llm-config.name }} LLM Test Results:
              ${{ env.INTEGRATION_TEST_REPORT }}
              ---
              Download testing outputs (${{ matrix.llm-config.name }} results): [Download](${{ steps.upload_results_artifact.outputs.artifact-url }})